#!/bin/bash
#author: Alan Huang, Justin Zhao
#date 12/10/2015
#Description: this is the pdu control script
#


. check_board
source power_op


# Usage information 
usage()
{
    echo "Usage: board_reboot [Num] [on|off|reboot]"
    echo "To power on, off or reboot specify boards, default to reboot board num=1 without any parameters!"
    echo "    Num:To operate the specified board assigned to user, Num is an interger board index which must be greater than 0, default to operate board num=1."
    echo "    on|off|reboot:  To specify a power operation, default to reboot."
    exit 0
} 



# check use status and connect boards
board_op()
{
    check_use_status "BOARDNUM"
    if [ "$current" = "" ];then
        board_op_power $1 $POWERINFO $OUTLET
	echo ""
    else
        current_user=`grep -w $current $USERCFG | cut -d ":" -f1`
        if [ "$current_user" = "$USERNAME" ];then
	    board_op_power $1 $POWERINFO $OUTLET
        else
            email=`grep -w $current $USERCFG`
            email=${email#*email=}
            email=${email%%,*}
            echo "              ********WARNING********"
            echo "  $email is using the board"
            echo "  Please wait until he/she  finishes the work"
            echo "  Or you can contact with him by email."
        fi
     fi
}



# according to the parameter num to take different handle
# if num=0, the cmd like board_reboot,the default is reboot the board num=1
# if num=1, the cmd like this: board_reboot num(board num) or board_reboot on|off|reboot(defaul operation board num=1) 
# if num=2, the cmd like this: board num on|off|reboot
# else ,the cmd is wrong

if [ $# = 0 ]; then
    board_op reboot 
    exit
elif [ $# = 1 ]; then
    if [ "$1" -gt 0 ] 2>/dev/null; then
        board_op reboot 
    else
        case $1 in
	"on"|"off"|"reboot")
	    board_op $1
	    ;;
        *)
	    usage
            ;;
         esac
     fi
     exit
elif [ $# = 2 ]; then
    if [ $1 -gt 0 ] 2>/dev/null; then
        case $2 in
	"on"|"off"|"reboot")
	    board_op $2
            ;;
        *)
            usage
            ;;
         esac
     fi
else
    usage
fi





















